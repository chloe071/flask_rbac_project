{% extends "base.html" %}
{% block content %}
<h2>Scenario Metrics: {{ scenario.name }}</h2>

<div id="timeToContainment" style="width: 100%; height: 400px;"></div>
<div id="meanResponseTime" style="width: 100%; height: 400px;"></div>
<div id="escalationCoverage" style="width: 100%; height: 400px;"></div>
<div id="userActionsBar" style="width: 100%; height: 400px;"></div>
<div id="timelineChart" style="width: 100%; height: 400px;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
fetch('{{ url_for("scenario_metrics", scenario_id=scenario.id) }}')
  .then(response => response.json())
  .then(data => {
    if(data.error){
      alert(data.error);
      return;
    }

    // Time to Containment - display as gauge or bar
    var ttc = data.time_to_containment_sec;
    var ttc_trace = {
      domain: { x: [0, 1], y: [0, 1] },
      value: ttc || 0,
      title: { text: 'Time to Containment (sec)', font: { size: 18 } },
      type: "indicator",
      mode: "gauge+number",
      gauge: { axis: { range: [null, 600] } }
    };
    Plotly.newPlot('timeToContainment', [ttc_trace]);

    // Mean response time bar
    var mrt = data.mean_response_time_sec || 0;
    var mrt_trace = {
      x: ['Mean Response Time (sec)'],
      y: [mrt],
      type: 'bar'
    };
    Plotly.newPlot('meanResponseTime', [mrt_trace]);

    // Escalation and coverage combined
    var escalation = data.escalation_count;
    var coverage = data.coverage_count;
    var ecc_trace = {
      x: ['Escalations', 'Coverage (unique users)'],
      y: [escalation, coverage],
      type: 'bar'
    };
    Plotly.newPlot('escalationCoverage', [ecc_trace]);

    // User action counts bar chart
    var userActions = data.user_action_counts;
    var userNames = Object.keys(userActions);
    var actionCounts = userNames.map(name => userActions[name]);
    var userActions_trace = {
      x: userNames,
      y: actionCounts,
      type: 'bar'
    };
    Plotly.newPlot('userActionsBar', [userActions_trace]);

    // Timeline (scatter plot)
    var timelineTrace = {
      x: data.action_timeline.map(t => t.timestamp),
      y: data.action_timeline.map((_, i) => i + 1),
      text: data.action_timeline.map(t => `${t.action_type} by ${t.user}`),
      mode: 'markers+lines',
      type: 'scatter'
    };
    var layout = {
      title: 'Action Timeline',
      xaxis: { title: 'Timestamp' },
      yaxis: { visible: false }
    };
    Plotly.newPlot('timelineChart', [timelineTrace], layout);

  })
  .catch(err => alert("Failed to fetch metrics data: " + err));
</script>
{% endblock %}